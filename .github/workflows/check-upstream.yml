name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
        id: check
        run: |
          UPSTREAM_REPO="frenck/spook"
          
          LATEST=$(curl -s "https://api.github.com/repos/${UPSTREAM_REPO}/releases/latest" | jq -r '.tag_name // empty')
          
          if [ -z "$LATEST" ]; then
            LATEST=$(curl -s "https://api.github.com/repos/${UPSTREAM_REPO}/tags" | jq -r '.[0].name // empty')
          fi
          
          CURRENT=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/-zh$//' || echo "none")
          
          echo "upstream=$LATEST" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "ä¸Šæ¸¸: $LATEST, å½“å‰: $CURRENT"
          
          if [ "$LATEST" != "$CURRENT" ] && [ -n "$LATEST" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»º Issue
        if: steps.check.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const upstream = '${{ steps.check.outputs.upstream }}';
            const current = '${{ steps.check.outputs.current }}';
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ä¸Šæ¸¸æ›´æ–°'
            });
            
            if (issues.data.find(i => i.title.includes(upstream))) return;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”„ ä¸Šæ¸¸æ›´æ–°: Spook ${upstream}`,
              body: `## æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–°\n\n` +
                    `| é¡¹ç›® | ç‰ˆæœ¬ |\n|------|------|\n` +
                    `| ä¸Šæ¸¸æœ€æ–° | \`${upstream}\` |\n` +
                    `| å½“å‰æ±‰åŒ– | \`${current}-zh\` |\n\n` +
                    `### åŸç‰ˆ Release\n` +
                    `ğŸ”— https://github.com/frenck/spook/releases\n\n` +
                    `---\n*è‡ªåŠ¨æ£€æµ‹*`,
              labels: ['ä¸Šæ¸¸æ›´æ–°', 'å¾…å¤„ç†']
            });
